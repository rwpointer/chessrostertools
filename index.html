<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SwissSys Pairing Slip Generator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Source+Code+Pro:wght@400;600&family=DM+Sans:wght@400;500;600&display=swap');

  :root {
    --ink: #1a1208;
    --cream: #f5f0e8;
    --parchment: #ede6d6;
    --gold: #c8912a;
    --gold-light: #e8b84b;
    --board-dark: #4a3728;
    --board-medium: #7a5c44;
    --green: #2d5a27;
    --red: #8b2020;
    --rule: #c8b89a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: repeating-conic-gradient(var(--parchment) 0% 25%, transparent 0% 50%);
    background-size: 40px 40px;
    opacity: 0.4;
    z-index: 0;
    pointer-events: none;
  }

  .wrapper {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 24px 60px;
  }

  header { text-align: center; margin-bottom: 36px; }
  .chess-icon { font-size: 44px; line-height: 1; margin-bottom: 10px; display: block; }
  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(26px, 4.5vw, 40px);
    font-weight: 900;
    color: var(--board-dark);
  }
  h1 span { color: var(--gold); }
  .subtitle { margin-top: 8px; color: var(--board-medium); font-size: 14px; font-weight: 500; }
  .rule-line { width: 100%; height: 2px; background: linear-gradient(to right, transparent, var(--gold), transparent); margin: 20px 0; }

  .card {
    background: white;
    border: 1px solid var(--rule);
    border-radius: 4px;
    padding: 24px 28px;
    margin-bottom: 18px;
    box-shadow: 0 2px 10px rgba(74,55,40,0.07);
  }

  .card-title {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--board-dark);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .step-badge {
    background: var(--gold);
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-weight: 700;
    width: 22px; height: 22px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  /* Drop Zone */
  .drop-zone {
    border: 2px dashed var(--rule);
    border-radius: 4px;
    padding: 36px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--cream);
  }
  .drop-zone:hover, .drop-zone.drag-over { border-color: var(--gold); background: #fdf8ef; }
  .drop-zone input { display: none; }
  .drop-icon { font-size: 32px; margin-bottom: 8px; display: block; }
  .drop-label { font-weight: 600; color: var(--board-dark); font-size: 14px; }
  .drop-sub { color: var(--board-medium); font-size: 12px; margin-top: 3px; }

  .file-info {
    display: none;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: #f0f7ef;
    border: 1px solid #b8d4b5;
    border-radius: 4px;
    margin-top: 10px;
  }
  .file-info.visible { display: flex; }
  .file-info .fn { font-weight: 600; font-size: 13px; color: var(--green); }

  /* Section selector */
  .section-list { display: flex; flex-direction: column; gap: 8px; }
  .section-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border: 1px solid var(--rule);
    border-radius: 4px;
    background: var(--cream);
    cursor: pointer;
    transition: all 0.15s;
  }
  .section-item:hover { border-color: var(--gold); background: #fdf8ef; }
  .section-item input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--gold); cursor: pointer; }
  .section-item label { cursor: pointer; flex: 1; }
  .sec-name { font-weight: 600; color: var(--board-dark); font-size: 14px; }
  .sec-meta { font-size: 12px; color: var(--board-medium); margin-top: 2px; }
  .sec-badge {
    background: var(--board-dark);
    color: white;
    font-size: 11px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 10px;
  }

  /* Settings row */
  .settings-row { display: flex; gap: 16px; flex-wrap: wrap; }
  .field { flex: 1; min-width: 140px; }
  .field label { display: block; font-size: 12px; font-weight: 700; color: var(--board-medium); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
  .field input, .field select {
    width: 100%; padding: 9px 12px;
    border: 1px solid var(--rule); border-radius: 3px;
    font-family: 'DM Sans', sans-serif; font-size: 13px;
    background: var(--cream); color: var(--ink);
    transition: border-color 0.15s;
  }
  .field input:focus, .field select:focus { outline: none; border-color: var(--gold); }

  /* Buttons */
  .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
  .btn {
    padding: 11px 24px;
    border: none; border-radius: 3px;
    font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
    display: flex; align-items: center; gap: 7px;
  }
  .btn:disabled { background: #ccc !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
  .btn-dark { background: var(--board-dark); color: white; }
  .btn-dark:hover:not(:disabled) { background: var(--board-medium); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(74,55,40,0.25); }
  .btn-gold { background: var(--gold); color: white; }
  .btn-gold:hover:not(:disabled) { background: var(--gold-light); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(200,145,42,0.3); }
  .btn-green { background: var(--green); color: white; }
  .btn-green:hover:not(:disabled) { background: #3d7a34; transform: translateY(-1px); }

  .status {
    padding: 10px 14px; border-radius: 3px; font-size: 13px; font-weight: 500;
    margin-top: 12px; display: none;
  }
  .status.ok { background: #f0f7ef; border: 1px solid #b8d4b5; color: var(--green); display: block; }
  .status.err { background: #fdf0f0; border: 1px solid #e8b5b5; color: var(--red); display: block; }

  /* â”€â”€â”€ PRINT PREVIEW AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #printArea {
    display: none;
    background: white;
    border: 1px solid var(--rule);
    border-radius: 4px;
    margin-top: 18px;
    padding: 20px;
  }

  #printArea h3 {
    font-family: 'Playfair Display', serif;
    font-size: 15px;
    color: var(--board-dark);
    margin-bottom: 14px;
  }

  /* Each print page */
  .print-page {
    width: 100%;
    max-width: 680px;
    margin: 0 auto 24px;
    border: 1px solid #ddd;
    background: white;
    padding: 12px;
  }

  .page-label {
    font-size: 10px;
    color: #aaa;
    text-align: right;
    margin-bottom: 6px;
    font-family: 'Source Code Pro', monospace;
    letter-spacing: 0.5px;
  }

  /* Individual slip */
  .slip {
    border: 1px solid #888;
    margin-bottom: 6px;
    padding: 7px 10px;
    break-inside: avoid;
  }
  .slip:last-child { margin-bottom: 0; }

  .slip-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    border-bottom: 1px solid #ccc;
    padding-bottom: 4px;
    margin-bottom: 5px;
  }

  .slip-title {
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #444;
  }

  .slip-board {
    font-size: 11px;
    font-weight: 700;
    color: #1a1208;
  }

  .slip-players {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .slip-row {
    display: grid;
    grid-template-columns: 26px 44px 1fr 44px 40px;
    align-items: center;
    gap: 4px;
    font-size: 10px;
  }

  .slip-color {
    font-weight: 700;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    color: #666;
  }

  .slip-team {
    font-size: 9px;
    font-weight: 700;
    color: #555;
    text-align: center;
    background: #f0f0f0;
    padding: 1px 3px;
    border-radius: 2px;
  }

  .slip-name {
    font-size: 10px;
    font-weight: 600;
    color: #1a1208;
  }

  .slip-score {
    font-size: 9px;
    color: #777;
    text-align: right;
  }

  .slip-result-box {
    border: 1px solid #aaa;
    width: 28px;
    height: 16px;
    display: inline-block;
  }

  .slip-bye {
    font-size: 10px;
    color: #888;
    font-style: italic;
    padding: 2px 0;
  }

  footer {
    text-align: center;
    color: var(--board-medium);
    font-size: 11px;
    margin-top: 36px;
    padding-top: 16px;
    border-top: 1px solid var(--rule);
  }

  /* â”€â”€â”€ PRINT STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media print {
    body { background: white; }
    body::before { display: none; }
    .wrapper { padding: 0; max-width: 100%; }
    header, .card, footer, #printArea h3, .page-label { display: none !important; }
    #printArea {
      display: block !important;
      border: none;
      padding: 0;
      margin: 0;
    }
    .print-page {
      max-width: 100%;
      border: none;
      padding: 0;
      margin: 0;
      page-break-after: always;
    }
    .print-page:last-child { page-break-after: avoid; }
    .slip { border: 1px solid #999; margin-bottom: 4px; }
    .page-label { display: none !important; }
  }
</style>
</head>
<body>
<div class="wrapper">

  <header>
    <span class="chess-icon">â™Ÿ</span>
    <h1>Pairing Slip <span>Generator</span></h1>
    <p class="subtitle">SwissSys Â· ChessRoster Â· Saint Louis Chess Club</p>
  </header>

  <div class="rule-line"></div>

  <!-- STEP 1: LOAD FILE -->
  <div class="card">
    <div class="card-title"><span class="step-badge">1</span>Load Pairings File</div>
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".txt,.prn,.lis,text/*">
      <span class="drop-icon">ðŸ“„</span>
      <div class="drop-label">Click to browse or drag &amp; drop</div>
      <div class="drop-sub">SwissSys/ChessRoster pairings .txt file</div>
    </div>
    <div class="file-info" id="fileInfo">
      <span>âœ…</span>
      <span class="fn" id="fileName">â€”</span>
    </div>
  </div>

  <!-- STEP 2: SELECT SECTIONS -->
  <div class="card">
    <div class="card-title"><span class="step-badge">2</span>Select Sections to Print</div>
    <div id="sectionList"><p style="color:#aaa;font-size:13px;">Load a file to see sections.</p></div>
    <div class="status" id="parseStatus"></div>
  </div>

  <!-- STEP 3: OPTIONS -->
  <div class="card">
    <div class="card-title"><span class="step-badge">3</span>Print Options</div>
    <div class="settings-row">
      <div class="field">
        <label>Slips Per Page</label>
        <select id="slipsPerPage">
          <option value="5" selected>5 (SwissSys default)</option>
          <option value="4">4</option>
          <option value="3">3</option>
          <option value="6">6</option>
        </select>
      </div>
      <div class="field">
        <label>Tournament Name Override</label>
        <input type="text" id="tourneyName" placeholder="(auto-detected from file)">
      </div>
      <div class="field">
        <label>Round Override</label>
        <input type="text" id="roundOverride" placeholder="(auto-detected from file)">
      </div>
    </div>
  </div>

  <!-- STEP 4: GENERATE -->
  <div class="card">
    <div class="card-title"><span class="step-badge">4</span>Generate &amp; Print</div>
    <div class="btn-row">
      <button class="btn btn-dark" id="btnGenerate" onclick="generateSlips()" disabled>âš™ Generate Slips</button>
      <button class="btn btn-gold" id="btnPrint" onclick="window.print()" disabled>ðŸ–¨ Print</button>
    </div>
    <div class="status" id="genStatus"></div>
  </div>

  <!-- PRINT AREA -->
  <div id="printArea">
    <h3>Print Preview â€” <span id="previewLabel"></span></h3>
    <div id="pages"></div>
  </div>

  <footer>Saint Louis Chess Club Â· Pairing Slip Generator Â· Built for SwissSys / ChessRoster</footer>
</div>

<script>
let parsedSections = [];

// â”€â”€ File loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('drag-over'); if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', () => { if (fileInput.files[0]) loadFile(fileInput.files[0]); });

function loadFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileInfo').classList.add('visible');
    parseFile(e.target.result);
  };
  reader.readAsText(file, 'latin1');
}

// â”€â”€ Parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function parseFile(content) {
  parsedSections = [];
  const lines = content.split(/\r?\n/);
  let currentSection = null;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // Detect section header: "Pairings for Round X. ..."
    const headerMatch = line.match(/^Pairings for (Round \d+)\.\s*(.+)$/i);
    if (headerMatch) {
      if (currentSection) parsedSections.push(currentSection);
      currentSection = {
        round: headerMatch[1],
        name: headerMatch[2].trim(),
        pairings: [],
        byes: []
      };
      continue;
    }

    if (!currentSection) continue;

    // Skip the column header row
    if (line.match(/^Bd\s+Team\s+Res/)) continue;

    // Skip blank lines
    if (!line.trim()) continue;

    // Parse pairing rows
    // Format: Bd\tTeam\tRes\tWhite\tTeam\tRes\tBlack
    const parts = line.split('\t');

    // Numbered board row: starts with a number
    const bdMatch = parts[0].trim().match(/^(\d+)$/);
    if (bdMatch) {
      const bd = parseInt(bdMatch[1]);
      const whiteName = (parts[3] || '').trim();
      const blackName = (parts[6] || '').trim();
      const whiteTeam = (parts[1] || '').trim();
      const blackTeam = (parts[4] || '').trim();
      const whiteRes = (parts[2] || '').trim();
      const blackRes = (parts[5] || '').trim();

      // Extract score from name "(X.X)" at end
      const extractScore = str => {
        const m = str.match(/\(([0-9.]+)\)\s*$/);
        return m ? { name: str.replace(/\s*\([0-9.]+\)\s*$/, '').trim(), score: m[1] } : { name: str, score: '' };
      };

      const white = extractScore(whiteName);
      const black = extractScore(blackName);

      currentSection.pairings.push({
        bd, 
        white: { team: whiteTeam, name: white.name, score: white.score, result: whiteRes },
        black: { team: blackTeam, name: black.name, score: black.score, result: blackRes }
      });
      continue;
    }

    // BYE rows (no board number, just team + player + BYE)
    if (parts[0].trim() === '' && line.includes('BYE')) {
      const team = (parts[1] || '').trim();
      const playerRaw = (parts[3] || '').trim();
      const extractScore = str => {
        const m = str.match(/\(([0-9.]+)\)\s*$/);
        return m ? { name: str.replace(/\s*\([0-9.]+\)\s*$/, '').trim(), score: m[1] } : { name: str, score: '' };
      };
      const player = extractScore(playerRaw);
      if (team || player.name) {
        currentSection.byes.push({ team, name: player.name, score: player.score });
      }
    }
  }

  if (currentSection) parsedSections.push(currentSection);

  renderSectionList();
}

function renderSectionList() {
  const container = document.getElementById('sectionList');
  if (!parsedSections.length) {
    container.innerHTML = '<p style="color:#c00;font-size:13px;">No sections found. Check file format.</p>';
    return;
  }

  container.innerHTML = '';
  const list = document.createElement('div');
  list.className = 'section-list';

  parsedSections.forEach((sec, i) => {
    const item = document.createElement('div');
    item.className = 'section-item';
    item.innerHTML = `
      <input type="checkbox" id="sec_${i}" checked>
      <label for="sec_${i}">
        <div class="sec-name">${sec.name}</div>
        <div class="sec-meta">${sec.round} Â· ${sec.pairings.length} boards${sec.byes.length ? ` Â· ${sec.byes.length} bye(s)` : ''}</div>
      </label>
      <span class="sec-badge">${sec.pairings.length}</span>
    `;
    list.appendChild(item);
  });

  container.appendChild(list);

  const total = parsedSections.reduce((s, sec) => s + sec.pairings.length, 0);
  setStatus('parseStatus', 'ok', `âœ“ Found ${parsedSections.length} section(s) â€” ${total} total boards.`);
  document.getElementById('btnGenerate').disabled = false;
}

// â”€â”€ Slip generation & reorder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function generateSlips() {
  const slipsPerPage = parseInt(document.getElementById('slipsPerPage').value);
  const tourneyOverride = document.getElementById('tourneyName').value.trim();
  const roundOverride = document.getElementById('roundOverride').value.trim();

  // Gather selected sections and flatten all pairings in order
  const selected = parsedSections.filter((_, i) =>
    document.getElementById(`sec_${i}`)?.checked
  );

  if (!selected.length) {
    setStatus('genStatus', 'err', 'Please select at least one section.');
    return;
  }

  // Build flat slip list across all selected sections
  let allSlips = [];
  selected.forEach(sec => {
    const round = roundOverride || sec.round;
    const sectionName = sec.name;
    const tourneyName = tourneyOverride || extractTourney(sectionName);

    sec.pairings.forEach(p => {
      allSlips.push({ sec: sectionName, round, tourney: tourneyName, pairing: p });
    });

    // Append byes as a note (optional â€” byes don't need a slip normally)
  });

  // Reorder slips: transpose so stacking gives consecutive boards
  const numSlips = allSlips.length;
  const numPages = Math.ceil(numSlips / slipsPerPage);

  // Build reordered slip sequence
  // New page k (0-indexed) gets slips at indices: k, k+numPages, k+2*numPages, ...
  const reorderedSlips = [];
  for (let k = 0; k < numPages; k++) {
    const pageSlips = [];
    for (let row = 0; row < slipsPerPage; row++) {
      const idx = k + row * numPages;
      if (idx < numSlips) pageSlips.push(allSlips[idx]);
    }
    reorderedSlips.push(pageSlips);
  }

  renderPages(reorderedSlips, slipsPerPage, numSlips, numPages);
  setStatus('genStatus', 'ok', `âœ“ Generated ${numSlips} slips across ${numPages} pages. Ready to print.`);
  document.getElementById('btnPrint').disabled = false;
}

function extractTourney(sectionName) {
  // Remove section suffix like ": K-12 Open" to get base tourney name
  // The file has format "Turkey Tango 2025: K-12 Open"
  const m = sectionName.match(/^(.+?)(?::\s*.+)?$/);
  return m ? m[1].trim() : sectionName;
}

function renderPages(pages, slipsPerPage, totalSlips, totalPages) {
  const pagesDiv = document.getElementById('pages');
  pagesDiv.innerHTML = '';

  document.getElementById('previewLabel').textContent =
    `${totalSlips} slips Â· ${totalPages} pages Â· ${slipsPerPage} per page`;

  pages.forEach((pageSlips, pi) => {
    const pageDiv = document.createElement('div');
    pageDiv.className = 'print-page';

    const lbl = document.createElement('div');
    lbl.className = 'page-label';
    lbl.textContent = `PAGE ${pi + 1} / ${totalPages}`;
    pageDiv.appendChild(lbl);

    pageSlips.forEach(slip => {
      pageDiv.appendChild(renderSlip(slip));
    });

    pagesDiv.appendChild(pageDiv);
  });

  const printArea = document.getElementById('printArea');
  printArea.style.display = 'block';
  printArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderSlip(slip) {
  const p = slip.pairing;
  const div = document.createElement('div');
  div.className = 'slip';

  // Section name â€” strip tourney prefix for brevity
  const secShort = slip.sec.replace(/^.+?:\s*/, '');

  div.innerHTML = `
    <div class="slip-header">
      <span class="slip-title">${slip.round} Â· ${secShort}</span>
      <span class="slip-board">Board ${p.bd}</span>
    </div>
    <div class="slip-players">
      ${renderPlayerRow('W', p.white)}
      ${renderPlayerRow('B', p.black)}
    </div>
  `;
  return div;
}

function renderPlayerRow(color, player) {
  if (!player.name) {
    return `<div class="slip-row"><span class="slip-color">${color}</span><span class="slip-bye" style="grid-column:2/-1">â€” BYE â€”</span></div>`;
  }
  return `
    <div class="slip-row">
      <span class="slip-color">${color}</span>
      <span class="slip-team">${player.team || 'â€”'}</span>
      <span class="slip-name">${player.name}</span>
      <span class="slip-score">(${player.score})</span>
      <span class="slip-result-box"></span>
    </div>
  `;
}

function setStatus(id, type, msg) {
  const el = document.getElementById(id);
  el.className = 'status ' + type;
  el.textContent = msg;
}
</script>
</body>
</html>
