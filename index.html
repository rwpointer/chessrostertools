<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SwissSys Pairing Slip Reorder</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Source+Code+Pro:wght@400;600&family=DM+Sans:wght@400;500;600&display=swap');

  :root {
    --ink: #1a1208;
    --cream: #f5f0e8;
    --parchment: #ede6d6;
    --gold: #c8912a;
    --gold-light: #e8b84b;
    --board-dark: #4a3728;
    --board-medium: #7a5c44;
    --green: #2d5a27;
    --red: #8b2020;
    --rule: #c8b89a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
  }

  /* Chess board pattern background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      repeating-conic-gradient(var(--parchment) 0% 25%, transparent 0% 50%);
    background-size: 40px 40px;
    opacity: 0.4;
    z-index: 0;
    pointer-events: none;
  }

  .wrapper {
    position: relative;
    z-index: 1;
    max-width: 860px;
    margin: 0 auto;
    padding: 40px 24px 60px;
  }

  header {
    text-align: center;
    margin-bottom: 40px;
  }

  .chess-icon {
    font-size: 48px;
    line-height: 1;
    margin-bottom: 12px;
    display: block;
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(28px, 5vw, 42px);
    font-weight: 900;
    color: var(--board-dark);
    letter-spacing: -0.5px;
    line-height: 1.1;
  }

  h1 span {
    color: var(--gold);
  }

  .subtitle {
    margin-top: 10px;
    color: var(--board-medium);
    font-size: 15px;
    font-weight: 500;
  }

  .rule-line {
    width: 100%;
    height: 2px;
    background: linear-gradient(to right, transparent, var(--gold), transparent);
    margin: 24px 0;
  }

  /* Cards */
  .card {
    background: white;
    border: 1px solid var(--rule);
    border-radius: 4px;
    padding: 28px 32px;
    margin-bottom: 20px;
    box-shadow: 0 2px 12px rgba(74,55,40,0.08);
  }

  .card-title {
    font-family: 'Playfair Display', serif;
    font-size: 17px;
    font-weight: 700;
    color: var(--board-dark);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card-title .step-badge {
    background: var(--gold);
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 600;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  /* Drop Zone */
  .drop-zone {
    border: 2px dashed var(--rule);
    border-radius: 4px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    background: var(--cream);
  }

  .drop-zone:hover,
  .drop-zone.drag-over {
    border-color: var(--gold);
    background: #fdf8ef;
  }

  .drop-zone input[type=file] {
    display: none;
  }

  .drop-icon { font-size: 36px; margin-bottom: 10px; display: block; }
  .drop-label { font-weight: 600; color: var(--board-dark); font-size: 15px; }
  .drop-sub { color: var(--board-medium); font-size: 13px; margin-top: 4px; }

  .file-chosen {
    display: none;
    align-items: center;
    gap: 12px;
    padding: 14px 18px;
    background: #f0f7ef;
    border: 1px solid #b8d4b5;
    border-radius: 4px;
    margin-top: 12px;
  }

  .file-chosen.visible { display: flex; }
  .file-chosen .file-icon { font-size: 24px; }
  .file-chosen .file-name { font-weight: 600; font-size: 14px; color: var(--green); }
  .file-chosen .file-size { font-size: 12px; color: #666; }

  /* Settings */
  .settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  @media (max-width: 600px) {
    .settings-grid { grid-template-columns: 1fr; }
  }

  .field label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--board-medium);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .field input, .field select {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--rule);
    border-radius: 3px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    background: var(--cream);
    color: var(--ink);
    transition: border-color 0.15s;
  }

  .field input:focus, .field select:focus {
    outline: none;
    border-color: var(--gold);
  }

  .field .hint {
    font-size: 12px;
    color: #999;
    margin-top: 5px;
  }

  .separator-preview {
    font-family: 'Source Code Pro', monospace;
    font-size: 12px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 3px;
    padding: 6px 10px;
    margin-top: 8px;
    white-space: pre;
    overflow-x: auto;
    max-height: 60px;
    color: #555;
    display: none;
  }

  /* Parse Status */
  .parse-status {
    display: none;
    padding: 12px 16px;
    border-radius: 3px;
    font-size: 13px;
    font-weight: 500;
    margin-top: 16px;
  }

  .parse-status.success {
    background: #f0f7ef;
    border: 1px solid #b8d4b5;
    color: var(--green);
    display: block;
  }

  .parse-status.error {
    background: #fdf0f0;
    border: 1px solid #e8b5b5;
    color: var(--red);
    display: block;
  }

  .parse-status.warn {
    background: #fffbef;
    border: 1px solid #e8d8a0;
    color: #7a5c00;
    display: block;
  }

  /* Preview */
  .preview-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  @media (max-width: 600px) { .preview-grid { grid-template-columns: 1fr; } }

  .preview-col h4 {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    color: var(--board-medium);
  }

  .preview-box {
    font-family: 'Source Code Pro', monospace;
    font-size: 11px;
    background: #f8f8f8;
    border: 1px solid #e0e0e0;
    border-radius: 3px;
    padding: 10px;
    height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
    color: #333;
    line-height: 1.5;
  }

  .pg-marker {
    background: var(--gold);
    color: white;
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 2px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  /* Stats bar */
  .stats-bar {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .stat-val {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    font-weight: 700;
    color: var(--board-dark);
    line-height: 1;
  }

  .stat-lbl {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--board-medium);
    font-weight: 600;
  }

  /* Process Button */
  .btn-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 8px;
  }

  .btn {
    padding: 13px 28px;
    border: none;
    border-radius: 3px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.2px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: var(--board-dark);
    color: white;
  }

  .btn-primary:hover {
    background: var(--board-medium);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74,55,40,0.3);
  }

  .btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .btn-gold {
    background: var(--gold);
    color: white;
  }

  .btn-gold:hover {
    background: var(--gold-light);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(200,145,42,0.35);
  }

  .btn-gold:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* Diagram */
  .diagram {
    background: var(--cream);
    border: 1px solid var(--rule);
    border-radius: 4px;
    padding: 20px;
    margin-top: 0;
  }

  .diagram-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--board-medium);
    margin-bottom: 14px;
  }

  .diagram-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 13px;
  }

  .d-label {
    width: 80px;
    font-weight: 600;
    color: var(--board-medium);
    font-size: 12px;
  }

  .d-slips {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }

  .d-slip {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    border-radius: 2px;
    font-family: 'Source Code Pro', monospace;
  }

  .d-slip.orig { background: var(--board-dark); color: white; }
  .d-slip.new-a { background: var(--gold); color: white; }
  .d-slip.new-b { background: var(--green); color: white; }
  .d-slip.new-c { background: #5b4fa0; color: white; }
  .d-slip.new-d { background: var(--red); color: white; }
  .d-slip.new-e { background: var(--board-medium); color: white; }

  .arrow { color: var(--board-medium); font-size: 18px; }

  .stack-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .stack {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }

  .stack-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--board-medium);
    font-weight: 700;
    margin-bottom: 3px;
  }

  .stack-items {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  footer {
    text-align: center;
    color: var(--board-medium);
    font-size: 12px;
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid var(--rule);
  }
</style>
</head>
<body>
<div class="wrapper">

  <header>
    <span class="chess-icon">â™Ÿ</span>
    <h1>Pairing Slip <span>Reorder</span></h1>
    <p class="subtitle">SwissSys â€¢ Tournament Print Utility â€¢ Saint Louis Chess Club</p>
  </header>

  <div class="rule-line"></div>

  <!-- HOW IT WORKS -->
  <div class="card">
    <div class="card-title">How It Works</div>
    <div class="diagram">
      <div class="diagram-title">Before â†’ After (example: 3 pages, 5 slips each)</div>
      <div class="diagram-row">
        <span class="d-label">Old Pg 1</span>
        <div class="d-slips">
          <div class="d-slip orig">1</div>
          <div class="d-slip orig">2</div>
          <div class="d-slip orig">3</div>
        </div>
        <span style="color:#bbb;font-size:11px;margin-left:4px">â†’ when cut &amp; stacked, pos 1 = 1,6,11...</span>
      </div>
      <div class="diagram-row">
        <span class="d-label">Old Pg 2</span>
        <div class="d-slips">
          <div class="d-slip orig">4</div>
          <div class="d-slip orig">5</div>
          <div class="d-slip orig">6</div>
        </div>
      </div>
      <div class="diagram-row">
        <span class="d-label">Old Pg 3</span>
        <div class="d-slips">
          <div class="d-slip orig">7</div>
          <div class="d-slip orig">8</div>
          <div class="d-slip orig">9</div>
        </div>
      </div>
      <div style="margin:12px 0 8px;font-size:12px;color:var(--board-medium);font-weight:600;">â†“ After reorder â†’ position 1 stacks = consecutive pairings</div>
      <div class="diagram-row">
        <span class="d-label">New Pg 1</span>
        <div class="d-slips">
          <div class="d-slip new-a">1</div>
          <div class="d-slip new-b">4</div>
          <div class="d-slip new-c">7</div>
        </div>
      </div>
      <div class="diagram-row">
        <span class="d-label">New Pg 2</span>
        <div class="d-slips">
          <div class="d-slip new-a">2</div>
          <div class="d-slip new-b">5</div>
          <div class="d-slip new-c">8</div>
        </div>
      </div>
      <div class="diagram-row">
        <span class="d-label">New Pg 3</span>
        <div class="d-slips">
          <div class="d-slip new-a">3</div>
          <div class="d-slip new-b">6</div>
          <div class="d-slip new-c">9</div>
        </div>
      </div>
      <div style="margin-top:12px;font-size:12px;color:var(--board-medium);">
        âœ“ Stack position 1 = pairings <strong>1,2,3</strong> &nbsp;|&nbsp; Stack position 2 = pairings <strong>4,5,6</strong> &nbsp;|&nbsp; Stack position 3 = pairings <strong>7,8,9</strong>
      </div>
    </div>
  </div>

  <!-- STEP 1: UPLOAD -->
  <div class="card">
    <div class="card-title"><span class="step-badge">1</span>Load SwissSys Text File</div>
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".txt,.prn,.lis,text/*">
      <span class="drop-icon">ðŸ“„</span>
      <div class="drop-label">Click to browse or drag &amp; drop</div>
      <div class="drop-sub">SwissSys pairing slip text files (.txt, .prn, .lis)</div>
    </div>
    <div class="file-chosen" id="fileChosen">
      <span class="file-icon">âœ…</span>
      <div>
        <div class="file-name" id="fileName">â€”</div>
        <div class="file-size" id="fileSize">â€”</div>
      </div>
    </div>
  </div>

  <!-- STEP 2: CONFIG -->
  <div class="card">
    <div class="card-title"><span class="step-badge">2</span>Configure Parsing</div>
    <div class="settings-grid">
      <div class="field">
        <label>Slips Per Page</label>
        <input type="number" id="slipsPerPage" value="5" min="1" max="20">
        <div class="hint">SwissSys default is 5</div>
      </div>
      <div class="field">
        <label>Slip Separator</label>
        <select id="separatorType">
          <option value="formfeed_page">Page break (form feed) splits pages only</option>
          <option value="blankline">Blank line between slips</option>
          <option value="dashes">Dashes line (---)</option>
          <option value="fixedlines">Fixed lines per slip</option>
        </select>
        <div class="hint">How slips are divided within a page</div>
      </div>
      <div class="field" id="linesPerSlipField" style="display:none">
        <label>Lines Per Slip</label>
        <input type="number" id="linesPerSlip" value="10" min="1" max="100">
        <div class="hint">Exact line count for each slip</div>
      </div>
      <div class="field">
        <label>Output Filename</label>
        <input type="text" id="outputName" value="pairings-reordered.txt" placeholder="pairings-reordered.txt">
      </div>
    </div>
    <div class="parse-status" id="parseStatus"></div>
    <div class="stats-bar" id="statsBar" style="display:none">
      <div class="stat"><span class="stat-val" id="statPages">â€”</span><span class="stat-lbl">Pages</span></div>
      <div class="stat"><span class="stat-val" id="statSlips">â€”</span><span class="stat-lbl">Total Slips</span></div>
      <div class="stat"><span class="stat-val" id="statRounds">â€”</span><span class="stat-lbl">Stack Groups</span></div>
    </div>
  </div>

  <!-- STEP 3: PREVIEW -->
  <div class="card" id="previewCard" style="display:none">
    <div class="card-title"><span class="step-badge">3</span>Preview</div>
    <div class="preview-grid">
      <div class="preview-col">
        <h4>Original (first 2 pages)</h4>
        <div class="preview-box" id="previewOrig"></div>
      </div>
      <div class="preview-col">
        <h4>Reordered (first 2 pages)</h4>
        <div class="preview-box" id="previewNew"></div>
      </div>
    </div>
  </div>

  <!-- STEP 4: DOWNLOAD -->
  <div class="card">
    <div class="card-title"><span class="step-badge">4</span>Process &amp; Download</div>
    <div class="btn-row">
      <button class="btn btn-primary" id="btnParse" onclick="parseFile()" disabled>
        âš™ Parse &amp; Analyze
      </button>
      <button class="btn btn-gold" id="btnDownload" onclick="downloadFile()" disabled>
        â¬‡ Download Reordered File
      </button>
    </div>
  </div>

  <footer>
    Saint Louis Chess Club Â· Pairing Slip Reorder Tool Â· Built for SwissSys tournament software
  </footer>
</div>

<script>
let rawContent = '';
let parsedSlips = [];
let reorderedContent = '';

// â”€â”€ File loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', () => fileInput.click());

dropZone.addEventListener('dragover', e => {
  e.preventDefault();
  dropZone.classList.add('drag-over');
});

dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));

dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) loadFile(file);
});

fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) loadFile(fileInput.files[0]);
});

document.getElementById('separatorType').addEventListener('change', () => {
  const v = document.getElementById('separatorType').value;
  document.getElementById('linesPerSlipField').style.display =
    v === 'fixedlines' ? 'block' : 'none';
  if (rawContent) autoAnalyze();
});

document.getElementById('slipsPerPage').addEventListener('change', () => {
  if (rawContent) autoAnalyze();
});

document.getElementById('linesPerSlip').addEventListener('change', () => {
  if (rawContent) autoAnalyze();
});

function loadFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    rawContent = e.target.result;
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatBytes(file.size);
    document.getElementById('fileChosen').classList.add('visible');

    // Auto-detect filename for output
    const base = file.name.replace(/\.[^.]+$/, '');
    document.getElementById('outputName').value = base + '-reordered.txt';

    document.getElementById('btnParse').disabled = false;
    autoDetect();
    autoAnalyze();
  };
  reader.readAsText(file, 'latin1'); // Support CP1252 from older Windows apps
}

// â”€â”€ Auto-detect format â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function autoDetect() {
  const hasFF = rawContent.includes('\f');
  const dashLines = (rawContent.match(/^-{5,}/m) || []).length;
  const blankLines = rawContent.split('\n\n').length - 1;

  const sel = document.getElementById('separatorType');
  if (hasFF) {
    sel.value = 'formfeed_page';
  } else if (dashLines > 2) {
    sel.value = 'dashes';
  } else if (blankLines > 2) {
    sel.value = 'blankline';
  }

  document.getElementById('linesPerSlipField').style.display = 'none';
}

// â”€â”€ Parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function splitIntoSlips(content) {
  const mode = document.getElementById('separatorType').value;
  const slipsPerPage = parseInt(document.getElementById('slipsPerPage').value) || 5;
  let slips = [];

  if (mode === 'formfeed_page') {
    // Form feeds split pages; we divide each page into N equal slip sections
    const pages = content.split('\f').map(p => p.replace(/\n+$/, ''));
    const validPages = pages.filter(p => p.trim().length > 0);
    for (const page of validPages) {
      const lines = page.split('\n');
      // Remove trailing empty lines
      while (lines.length && !lines[lines.length-1].trim()) lines.pop();
      const linesPerSlip = Math.floor(lines.length / slipsPerPage);
      for (let i = 0; i < slipsPerPage; i++) {
        const start = i * linesPerSlip;
        const end = i === slipsPerPage - 1 ? lines.length : start + linesPerSlip;
        const slipLines = lines.slice(start, end);
        slips.push(slipLines.join('\n'));
      }
    }
  } else if (mode === 'blankline') {
    slips = content.split(/\n{2,}/).map(s => s.trim()).filter(s => s.length > 0);
  } else if (mode === 'dashes') {
    slips = content.split(/^-{5,}.*$/m).map(s => s.trim()).filter(s => s.length > 0);
  } else if (mode === 'fixedlines') {
    const linesPerSlip = parseInt(document.getElementById('linesPerSlip').value) || 10;
    const allLines = content.split('\n');
    for (let i = 0; i < allLines.length; i += linesPerSlip) {
      const chunk = allLines.slice(i, i + linesPerSlip);
      if (chunk.some(l => l.trim())) {
        slips.push(chunk.join('\n'));
      }
    }
  }

  return slips;
}

function getSeparator() {
  const mode = document.getElementById('separatorType').value;
  if (mode === 'formfeed_page') return '\f';
  if (mode === 'blankline') return '\n\n';
  if (mode === 'dashes') return '\n' + '-'.repeat(60) + '\n';
  return '\n';
}

function reorderSlips(slips, slipsPerPage) {
  const totalSlips = slips.length;
  const numPages = Math.ceil(totalSlips / slipsPerPage);
  // We have numPages "old pages". New page k (0-indexed) gets:
  //   slip k, slip k+numPages, slip k+2*numPages, ..., slip k+(slipsPerPage-1)*numPages
  const newSlips = [];
  for (let k = 0; k < numPages; k++) {
    const pageSlips = [];
    for (let row = 0; row < slipsPerPage; row++) {
      const idx = k + row * numPages;
      if (idx < totalSlips) {
        pageSlips.push(slips[idx]);
      }
    }
    newSlips.push(pageSlips);
  }
  return newSlips; // array of pages, each page is array of slip texts
}

function autoAnalyze() {
  try {
    const slips = splitIntoSlips(rawContent);
    const slipsPerPage = parseInt(document.getElementById('slipsPerPage').value) || 5;
    const numPages = Math.ceil(slips.length / slipsPerPage);

    document.getElementById('statPages').textContent = numPages;
    document.getElementById('statSlips').textContent = slips.length;
    document.getElementById('statRounds').textContent = slipsPerPage;
    document.getElementById('statsBar').style.display = 'flex';

    parsedSlips = slips;
    setStatus('success', `âœ“ Detected ${slips.length} slips across ${numPages} pages. Ready to reorder.`);
  } catch(e) {
    setStatus('error', 'âœ— Parse error: ' + e.message);
  }
}

function parseFile() {
  if (!rawContent) return;
  try {
    parsedSlips = splitIntoSlips(rawContent);
    const slipsPerPage = parseInt(document.getElementById('slipsPerPage').value) || 5;
    const numPages = Math.ceil(parsedSlips.length / slipsPerPage);

    if (parsedSlips.length === 0) {
      setStatus('error', 'âœ— No slips found. Try a different separator setting.');
      return;
    }

    document.getElementById('statPages').textContent = numPages;
    document.getElementById('statSlips').textContent = parsedSlips.length;
    document.getElementById('statRounds').textContent = slipsPerPage;
    document.getElementById('statsBar').style.display = 'flex';

    // Build reordered content
    const reordered = reorderSlips(parsedSlips, slipsPerPage);
    const sep = getSeparator();

    let lines = [];
    for (let p = 0; p < reordered.length; p++) {
      lines.push(reordered[p].join(sep === '\f' ? '\n' : sep));
      if (p < reordered.length - 1) lines.push(sep === '\f' ? '\f' : '');
    }
    reorderedContent = sep === '\f'
      ? reordered.map(page => page.join('\n')).join('\f')
      : reordered.map(page => page.join('\n' + sep.trim() + '\n')).join('\n' + sep.trim() + '\n');

    // Show preview
    showPreview(parsedSlips, reordered, slipsPerPage);
    document.getElementById('btnDownload').disabled = false;
    setStatus('success', `âœ“ Reordered ${parsedSlips.length} slips into ${reordered.length} new pages. Click Download to save.`);
  } catch(e) {
    setStatus('error', 'âœ— Error: ' + e.message);
  }
}

function showPreview(slips, reordered, slipsPerPage) {
  const previewCard = document.getElementById('previewCard');
  previewCard.style.display = 'block';

  // Original: show first 2 pages worth of slips
  const origSlices = slips.slice(0, slipsPerPage * 2);
  let origText = '';
  for (let i = 0; i < origSlices.length; i++) {
    if (i % slipsPerPage === 0) {
      origText += `â”€â”€ PAGE ${Math.floor(i/slipsPerPage)+1} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
    }
    origText += `[Slip ${i+1}]\n`;
    origText += truncateSlip(origSlices[i]) + '\n\n';
  }
  document.getElementById('previewOrig').textContent = origText;

  // Reordered: show first 2 pages
  let newText = '';
  for (let p = 0; p < Math.min(2, reordered.length); p++) {
    newText += `â”€â”€ NEW PAGE ${p+1} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
    for (let j = 0; j < reordered[p].length; j++) {
      const origIdx = slips.indexOf(reordered[p][j]);
      newText += `[Was slip ${origIdx+1}]\n`;
      newText += truncateSlip(reordered[p][j]) + '\n\n';
    }
  }
  document.getElementById('previewNew').textContent = newText;
}

function truncateSlip(text) {
  const lines = text.split('\n').slice(0, 4);
  return lines.join('\n') + (text.split('\n').length > 4 ? '\n  ...' : '');
}

function downloadFile() {
  if (!reorderedContent) { parseFile(); if (!reorderedContent) return; }
  const name = document.getElementById('outputName').value || 'pairings-reordered.txt';
  const blob = new Blob([reorderedContent], { type: 'text/plain;charset=latin1' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = name;
  a.click();
  URL.revokeObjectURL(url);
}

function setStatus(type, msg) {
  const el = document.getElementById('parseStatus');
  el.className = 'parse-status ' + type;
  el.textContent = msg;
}

function formatBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}
</script>
</body>
</html>
