<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RoundReady â€” The TD Toolkit</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;600&display=swap');

  :root {
    --ink: #0f1b2d;
    --cream: #f0f3f8;
    --parchment: #e2e8f2;
    --accent: #1e3a6e;
    --accent-light: #2d5aa0;
    --board-dark: #0f1b2d;
    --board-medium: #3a567a;
    --green: #1a5c35;
    --red: #8b2020;
    --rule: #b0bfd4;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: repeating-conic-gradient(var(--parchment) 0% 25%, transparent 0% 50%);
    background-size: 40px 40px;
    opacity: 0.4;
    z-index: 0;
    pointer-events: none;
  }

  .wrapper {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 24px 60px;
  }

  header { text-align: center; margin-bottom: 36px; }
  .chess-icon { font-size: 44px; line-height: 1; margin-bottom: 10px; display: block; }
  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(32px, 6vw, 52px);
    font-weight: 900;
    line-height: 1;
    letter-spacing: -1px;
  }
  .title-round { color: #1e3a6e; font-style: normal; }
  .title-ready { color: #c0141c; font-style: italic; }
  .tagline {
    font-family: 'Playfair Display', serif;
    font-size: clamp(13px, 2vw, 17px);
    font-weight: 700;
    color: var(--board-medium);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-top: 6px;
  }
  .subtitle { margin-top: 5px; color: #aaa; font-size: 12px; font-weight: 500; letter-spacing: 0.5px; }
  .rule-line { width: 100%; height: 2px; background: linear-gradient(to right, transparent, var(--accent), transparent); margin: 20px 0; }

  .card {
    background: white;
    border: 1px solid var(--rule);
    border-radius: 4px;
    padding: 24px 28px;
    margin-bottom: 18px;
    box-shadow: 0 2px 10px rgba(74,55,40,0.07);
  }

  .card-title {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--board-dark);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .step-badge {
    background: var(--accent);
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-weight: 700;
    width: 22px; height: 22px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  .drop-zone {
    border: 2px dashed var(--rule);
    border-radius: 4px;
    padding: 36px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--cream);
  }
  .drop-zone:hover, .drop-zone.drag-over { border-color: var(--accent-light); background: #eaf0fb; }
  .drop-zone input { display: none; }
  .drop-icon { font-size: 32px; margin-bottom: 8px; display: block; }
  .drop-label { font-weight: 600; color: var(--board-dark); font-size: 14px; }
  .drop-sub { color: var(--board-medium); font-size: 12px; margin-top: 3px; }

  .file-info {
    display: none;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: #f0f7ef;
    border: 1px solid #b8d4b5;
    border-radius: 4px;
    margin-top: 10px;
  }
  .file-info.visible { display: flex; }
  .file-info .fn { font-weight: 600; font-size: 13px; color: var(--green); }

  .section-list { display: flex; flex-direction: column; gap: 8px; }
  .section-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border: 1px solid var(--rule);
    border-radius: 4px;
    background: var(--cream);
    cursor: pointer;
    transition: all 0.15s;
  }
  .section-item:hover { border-color: var(--accent-light); background: #eaf0fb; }
  .section-item input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--accent); cursor: pointer; }
  .section-item label { cursor: pointer; flex: 1; }
  .sec-name { font-weight: 600; color: var(--board-dark); font-size: 14px; }
  .sec-meta { font-size: 12px; color: var(--board-medium); margin-top: 2px; }
  .sec-badge { background: var(--board-dark); color: white; font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 10px; }

  .settings-row { display: flex; gap: 16px; flex-wrap: wrap; }
  .field { flex: 1; min-width: 140px; }
  .field label { display: block; font-size: 12px; font-weight: 700; color: var(--board-medium); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
  .field input, .field select {
    width: 100%; padding: 9px 12px;
    border: 1px solid var(--rule); border-radius: 3px;
    font-family: 'DM Sans', sans-serif; font-size: 13px;
    background: var(--cream); color: var(--ink);
    transition: border-color 0.15s;
  }
  .field input:focus, .field select:focus { outline: none; border-color: var(--accent-light); }

  .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
  .btn {
    padding: 11px 24px;
    border: none; border-radius: 3px;
    font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
    display: flex; align-items: center; gap: 7px;
  }
  .btn:disabled { background: #ccc !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
  .btn-dark { background: var(--accent); color: white; }
  .btn-dark:hover:not(:disabled) { background: var(--accent-light); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(30,58,110,0.3); }
  .btn-gold { background: var(--board-medium); color: white; }
  .btn-gold:hover:not(:disabled) { background: var(--accent-light); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(30,58,110,0.25); }

  .status {
    padding: 10px 14px; border-radius: 3px; font-size: 13px; font-weight: 500;
    margin-top: 12px; display: none;
  }
  .status.ok { background: #f0f7ef; border: 1px solid #b8d4b5; color: var(--green); display: block; }
  .status.err { background: #fdf0f0; border: 1px solid #e8b5b5; color: var(--red); display: block; }

  /* â”€â”€ PRINT PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #printArea {
    display: none;
    background: #777;
    border-radius: 4px;
    margin-top: 18px;
    padding: 24px;
  }

  #printArea h3 {
    font-family: 'Playfair Display', serif;
    font-size: 13px;
    color: white;
    margin-bottom: 16px;
    text-align: center;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  /* â”€â”€ PRINT PAGE: 8.5Ã—11 with 0.2in top/bottom margin room â”€â”€â”€â”€â”€â”€â”€ */
  .print-page {
    width: 8.5in;
    height: 10.6in;        /* 11in minus 0.2in top + 0.2in bottom margin */
    background: white;
    margin: 0 auto 24px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 4px 24px rgba(0,0,0,0.4);
  }

  /* â”€â”€ SLIP: flex-fill so borders don't push 5th slip off page â”€â”€â”€â”€â”€ */
  .slip {
    width: 100%;
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: row;
    border-bottom: 1.5px dashed #bbb;
    overflow: hidden;
  }
  .slip:last-child { border-bottom: none; }

  /* â”€ WHITE side (left) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .slip-white {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 0.14in 0.18in 0.14in 0.20in;
    border-right: 1px solid #e0e0e0;
    background: #fafafa;
  }

  /* â”€ CENTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .slip-center {
    width: 1.85in;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 0.06in 0.08in 0.06in;
    border-right: 1px solid #e0e0e0;
    background: white;
    text-align: center;
  }

  /* â”€ BLACK side (right) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .slip-black {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 0.14in 0.20in 0.14in 0.18in;
    background: #fafafa;
  }

  /* Player info */
  .player-top { display: flex; flex-direction: column; gap: 5px; }

  .player-color-label {
    font-size: 9pt;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #888;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .color-box {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid #333;
    flex-shrink: 0;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  .color-box-white { background: white; }
  .color-box-black { background: #1a1208; border-color: #1a1208; }

  .player-name {
    font-size: 20pt;
    font-weight: 700;
    color: #1a1208;
    line-height: 1.1;
    word-break: break-word;
  }

  .player-meta {
    font-size: 11pt;
    color: #555;
    margin-top: 2px;
    font-weight: 600;
  }

  .player-meta strong { font-weight: 800; color: #333; }

  /* Signature */
  .player-sig { display: flex; flex-direction: column; gap: 5px; }
  .sig-label { font-size: 8pt; color: #bbb; text-transform: uppercase; letter-spacing: 0.8px; }
  .sig-line { border-bottom: 1.5px solid #bbb; width: 100%; height: 22px; }

  /* Center: board + section info */
  .center-top { display: flex; flex-direction: column; align-items: center; gap: 1px; }

  .board-label {
    font-size: 7pt;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: #aaa;
    font-weight: 700;
  }

  .board-number {
    font-family: 'Playfair Display', serif;
    font-size: 28pt;
    font-weight: 900;
    color: #1a1208;
    line-height: 1;
  }

  .center-section {
    font-size: 7.5pt;
    color: #777;
    font-weight: 600;
    line-height: 1.35;
    padding: 0 4px;
    margin-top: 2px;
  }

  /* Result */
  .result-area { display: flex; flex-direction: column; align-items: center; gap: 3px; width: 100%; }
  .result-label { font-size: 7pt; text-transform: uppercase; letter-spacing: 0.8px; color: #bbb; font-weight: 700; }

  .result-options { display: flex; flex-direction: column; gap: 4px; width: 100%; align-items: flex-start; padding: 0 0.08in; }

  .result-option {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .result-circle {
    width: 20px;
    height: 20px;
    border: 2px solid #777;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .result-text {
    font-size: 10pt;
    font-weight: 700;
    color: #333;
  }

  .result-sub {
    font-size: 7pt;
    color: #bbb;
    margin-left: 2px;
  }

  /* Bye */
  .slip-bye-msg {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    font-size: 10pt;
    color: #bbb;
    font-style: italic;
    letter-spacing: 1px;
  }

  footer {
    text-align: center;
    color: var(--board-medium);
    font-size: 11px;
    margin-top: 36px;
    padding-top: 16px;
    border-top: 1px solid var(--rule);
  }

  /* â”€â”€ PRINT MEDIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media print {
    @page { size: 8.5in 11in; margin: 0.2in 0; }

    body { background: white; }
    body::before { display: none !important; }
    .wrapper { display: none !important; }

    #printArea {
      display: block !important;
      background: none !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    #printArea h3 { display: none !important; }

    .print-page {
      width: 8.5in;
      height: 10.6in;   /* 11in - 0.2in top - 0.2in bottom */
      margin: 0;
      padding: 0;
      page-break-after: always;
      box-shadow: none;
    }

    .print-page:last-child { page-break-after: avoid; }
  }
  /* â”€â”€ RESULTS SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .results-page {
    width: 8.5in;
    height: 10.6in;
    background: white;
    margin: 0 auto 24px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 24px rgba(0,0,0,0.4);
    padding: 0.25in 0.3in 0.2in;
  }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    border-bottom: 2.5px solid #0f1b2d;
    padding-bottom: 6px;
    margin-bottom: 10px;
    flex-shrink: 0;
  }

  .results-title {
    font-family: 'Playfair Display', serif;
    font-size: 16pt;
    font-weight: 900;
    color: #0f1b2d;
    line-height: 1;
  }

  .results-meta {
    font-size: 9pt;
    color: #555;
    font-weight: 600;
    text-align: right;
    line-height: 1.5;
  }

  .results-table {
    width: 100%;
    border-collapse: collapse;
    flex: 1;
    font-size: 8.5pt;
  }

  .results-table thead tr {
    background: #0f1b2d;
    color: white;
  }

  .results-table thead th {
    padding: 4px 6px;
    font-weight: 700;
    font-size: 7.5pt;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  .results-table tbody tr {
    border-bottom: 1px solid #dde3ec;
  }

  .results-table tbody tr:nth-child(even) {
    background: #f5f7fb;
  }

  .results-table tbody td {
    padding: 3.5px 6px;
    vertical-align: middle;
    font-size: 8.5pt;
    color: #1a1208;
  }

  .rt-bd {
    width: 28px;
    text-align: center;
    font-weight: 800;
    color: #0f1b2d;
    font-size: 9pt;
  }

  .rt-team {
    width: 44px;
    font-size: 7.5pt;
    font-weight: 700;
    color: #3a567a;
    text-align: center;
  }

  .rt-name { font-weight: 600; }

  .rt-result {
    width: 1.5in;
    text-align: center;
  }

  .rt-result-inner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .rt-circle {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 7.5pt;
    font-weight: 700;
    color: #333;
  }

  .rt-circle-dot {
    width: 13px;
    height: 13px;
    border: 1.5px solid #777;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
  }

  .rt-bye {
    font-style: italic;
    color: #bbb;
    font-size: 8pt;
    text-align: center;
  }

  .results-footer-note {
    margin-top: 8px;
    font-size: 7pt;
    color: #bbb;
    text-align: right;
    flex-shrink: 0;
  }

  @media print {
    .results-page {
      width: 8.5in;
      height: 10.6in;
      margin: 0;
      padding: 0.25in 0.3in 0.2in;
      page-break-after: always;
      box-shadow: none;
    }
    .results-page:last-child { page-break-after: avoid; }
  }
  /* â”€â”€ ALPHA LOOKUP SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .alpha-page {
    width: 8.5in;
    height: 10.6in;
    background: white;
    margin: 0 auto 24px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 24px rgba(0,0,0,0.4);
    padding: 0.25in 0.3in 0.2in;
  }

  .alpha-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    border-bottom: 2.5px solid #0f1b2d;
    padding-bottom: 6px;
    margin-bottom: 12px;
    flex-shrink: 0;
  }

  .alpha-title {
    font-family: 'Playfair Display', serif;
    font-size: 16pt;
    font-weight: 900;
    color: #0f1b2d;
    line-height: 1;
  }

  .alpha-meta {
    font-size: 9pt;
    color: #555;
    font-weight: 600;
    text-align: right;
    line-height: 1.5;
  }

  .alpha-columns {
    display: flex;
    flex-direction: column;
    flex: 1;
    align-content: start;
  }

  .alpha-row {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 8px;
    border-bottom: 1px solid #e8ecf2;
    padding: 2.5px 6px;
  }

  .alpha-row:nth-child(even) { background: #f5f7fb; }

  .alpha-name {
    font-size: 9pt;
    font-weight: 700;
    color: #0f1b2d;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .alpha-team {
    font-size: 7.5pt;
    color: #3a567a;
    font-weight: 700;
  }

  .alpha-assignment {
    font-size: 8.5pt;
    color: #444;
    white-space: nowrap;
    text-align: right;
  }

  .alpha-color-w {
    font-weight: 800;
    color: #555;
  }

  .alpha-color-b {
    font-weight: 800;
    color: #0f1b2d;
  }

  .alpha-bye-tag {
    font-size: 7.5pt;
    color: #bbb;
    font-style: italic;
  }

  .alpha-col-header {
    font-size: 7pt;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #fff;
    background: #0f1b2d;
    padding: 4px 6px;
    margin-bottom: 0;
    display: grid;
    grid-template-columns: 1fr auto;
  }

  @media print {
    .alpha-page {
      width: 8.5in;
      height: 10.6in;
      margin: 0;
      padding: 0.25in 0.3in 0.2in;
      page-break-after: always;
      box-shadow: none;
    }
    .alpha-page:last-child { page-break-after: avoid; }
  }
</style>
</head>
<body>

<div class="wrapper">
  <header>
    <span class="chess-icon">â™ž</span>
    <h1><span class="title-round">Round</span><em class="title-ready">Ready</em></h1>
    <p class="tagline">The TD Toolkit</p>
    <p class="subtitle">Developed by Richard Pointer Â· IO IA</p>
  </header>

  <div class="rule-line"></div>

  <!-- STEP 1 -->
  <div class="card">
    <div class="card-title"><span class="step-badge">1</span>Load Pairings File</div>
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".txt,.prn,.lis,text/*">
      <span class="drop-icon">ðŸ“„</span>
      <div class="drop-label">Click to browse or drag &amp; drop</div>
      <div class="drop-sub">SwissSys / ChessRoster pairings .txt file</div>
    </div>
    <div class="file-info" id="fileInfo">
      <span>âœ…</span>
      <span class="fn" id="fileName">â€”</span>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="card">
    <div class="card-title"><span class="step-badge">2</span>Select Sections to Print</div>
    <div id="sectionList"><p style="color:#bbb;font-size:13px;">Load a file to see sections.</p></div>
    <div class="status" id="parseStatus"></div>
  </div>

  <!-- STEP 3 -->
  <div class="card">
    <div class="card-title"><span class="step-badge">3</span>Options</div>
    <div class="settings-row">
      <div class="field">
        <label>Slips Per Page</label>
        <select id="slipsPerPage">
          <option value="5" selected>5 (fills 8.5Ã—11)</option>
          <option value="4">4</option>
          <option value="3">3</option>
        </select>
      </div>
      <div class="field">
        <label>Tournament Name Override</label>
        <input type="text" id="tourneyName" placeholder="(auto-detected)">
      </div>
      <div class="field">
        <label>Round Override</label>
        <input type="text" id="roundOverride" placeholder="(auto-detected)">
      </div>
      <div class="field">
        <label>Time Control</label>
        <input type="text" id="timeControl" placeholder="e.g. G/30 +5">
      </div>
    </div>
    <div style="margin-top:14px;display:flex;align-items:center;gap:10px;">
      <input type="checkbox" id="includeResults" checked style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer;">
      <label for="includeResults" style="font-size:13px;font-weight:600;color:var(--board-dark);cursor:pointer;">
        Include a results recording sheet after each section's pairing slips
      </label>
    </div>
    <div style="margin-top:10px;display:flex;align-items:center;gap:10px;">
      <input type="checkbox" id="includeAlpha" checked style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer;">
      <label for="includeAlpha" style="font-size:13px;font-weight:600;color:var(--board-dark);cursor:pointer;">
        Include an alphabetical player lookup sheet after each section's results sheet
      </label>
    </div>
  </div>

  <!-- STEP 4 -->
  <div class="card">
    <div class="card-title"><span class="step-badge">4</span>Generate &amp; Print</div>
    <p style="font-size:13px;color:var(--board-medium);margin-bottom:14px;line-height:1.6;">
      Generates <strong>pairing slips</strong> (5 per page, reordered for clean stacking), an optional
      <strong>results recording sheet</strong>, and an optional <strong>alphabetical player lookup sheet</strong>
      â€” all per section, in a single print run.
    </p>
    <div class="btn-row">
      <button class="btn btn-dark" id="btnGenerate" onclick="generateSlips()" disabled>âš™ Generate</button>
      <button class="btn btn-gold" id="btnPrint" onclick="window.print()" disabled>ðŸ–¨ Print All Sheets</button>
    </div>
    <div class="status" id="genStatus"></div>
  </div>

  <footer>RoundReady Â· The TD Toolkit Â· Developed by Richard Pointer Â· IO IA</footer>
</div>

<!-- PRINT AREA â€” lives outside .wrapper so it prints alone -->
<div id="printArea">
  <h3>â–¼ Print Preview â€” <span id="previewLabel"></span></h3>
  <div id="pages"></div>
</div>

<script>
let parsedSections = [];

// â”€â”€ File loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dropZone  = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('drag-over');
  if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', () => { if (fileInput.files[0]) loadFile(fileInput.files[0]); });

function loadFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileInfo').classList.add('visible');
    parseFile(e.target.result);
  };
  reader.readAsText(file, 'latin1');
}

// â”€â”€ Parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseFile(content) {
  parsedSections = [];
  const lines = content.split(/\r?\n/);
  let cur = null;

  const extractScore = str => {
    const m = str.match(/\(([0-9.Â½]+)\)\s*$/);
    return m
      ? { name: str.replace(/\s*\([0-9.Â½]+\)\s*$/, '').trim(), score: m[1] }
      : { name: str.trim(), score: '' };
  };

  for (const line of lines) {
    const hdr = line.match(/^Pairings for (Round \d+)\.\s*(.+)$/i);
    if (hdr) {
      if (cur) parsedSections.push(cur);
      cur = { round: hdr[1], name: hdr[2].trim(), pairings: [], byes: [] };
      continue;
    }
    if (!cur || line.match(/^Bd\s+Team\s+Res/) || !line.trim()) continue;

    const parts = line.split('\t');
    const bdM = parts[0].trim().match(/^(\d+)$/);
    if (bdM) {
      const w = extractScore((parts[3] || '').trim());
      const b = extractScore((parts[6] || '').trim());
      cur.pairings.push({
        bd: parseInt(bdM[1]),
        white: { team: (parts[1]||'').trim(), name: w.name, score: w.score },
        black: { team: (parts[4]||'').trim(), name: b.name, score: b.score }
      });
    } else if (parts[0].trim() === '' && line.includes('BYE')) {
      const p = extractScore((parts[3]||'').trim());
      if ((parts[1]||'').trim() || p.name)
        cur.byes.push({ team: (parts[1]||'').trim(), name: p.name, score: p.score });
    }
  }
  if (cur) parsedSections.push(cur);
  renderSectionList();
}

function renderSectionList() {
  const container = document.getElementById('sectionList');
  if (!parsedSections.length) {
    container.innerHTML = '<p style="color:#c00;font-size:13px;">No sections found. Check file format.</p>';
    return;
  }
  container.innerHTML = '';
  const list = document.createElement('div');
  list.className = 'section-list';
  parsedSections.forEach((sec, i) => {
    const item = document.createElement('div');
    item.className = 'section-item';
    item.innerHTML = `
      <input type="checkbox" id="sec_${i}" checked>
      <label for="sec_${i}">
        <div class="sec-name">${sec.name}</div>
        <div class="sec-meta">${sec.round} Â· ${sec.pairings.length} boards${sec.byes.length ? ` Â· ${sec.byes.length} bye(s)` : ''}</div>
      </label>
      <span class="sec-badge">${sec.pairings.length}</span>
    `;
    list.appendChild(item);
  });
  container.appendChild(list);
  const total = parsedSections.reduce((s, sec) => s + sec.pairings.length, 0);
  setStatus('parseStatus', 'ok', `âœ“ Found ${parsedSections.length} section(s) â€” ${total} total boards.`);
  document.getElementById('btnGenerate').disabled = false;
}

// â”€â”€ Generate & reorder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateSlips() {
  const slipsPerPage    = parseInt(document.getElementById('slipsPerPage').value);
  const tourneyOver     = document.getElementById('tourneyName').value.trim();
  const roundOver       = document.getElementById('roundOverride').value.trim();
  const includeResults  = document.getElementById('includeResults').checked;
  const includeAlpha    = document.getElementById('includeAlpha').checked;

  const selected = parsedSections.filter((_, i) => document.getElementById(`sec_${i}`)?.checked);
  if (!selected.length) { setStatus('genStatus', 'err', 'Please select at least one section.'); return; }

  const pagesDiv = document.getElementById('pages');
  pagesDiv.innerHTML = '';

  let totalSlips = 0;
  let totalPages = 0;

  const slipH = null; // flex handles height now

  selected.forEach(sec => {
    const roundLabel = roundOver || sec.round;
    const slips = sec.pairings.map(p => ({
      sec: sec.name, round: roundLabel, tourney: tourneyOver || sec.name, pairing: p
    }));

    const numSlips = slips.length;
    const numPages = Math.ceil(numSlips / slipsPerPage);

    // Transpose reorder within this section
    for (let k = 0; k < numPages; k++) {
      const pg = [];
      for (let row = 0; row < slipsPerPage; row++) {
        const idx = k + row * numPages;
        if (idx < numSlips) pg.push(slips[idx]);
      }
      // Render page
      const pageDiv = document.createElement('div');
      pageDiv.className = 'print-page';
      pg.forEach(slip => pageDiv.appendChild(renderSlip(slip, slipH)));
      pagesDiv.appendChild(pageDiv);
    }

    totalSlips += numSlips;
    totalPages += numPages;

    // Results sheet for this section
    if (includeResults) {
      pagesDiv.appendChild(renderResultsSheet(sec, roundLabel));
      totalPages++;
    }

    // Alpha lookup sheet for this section
    if (includeAlpha) {
      pagesDiv.appendChild(renderAlphaSheet(sec, roundLabel));
      totalPages++;
    }
  });

  document.getElementById('previewLabel').textContent =
    `${totalSlips} slips Â· ${totalPages} pages Â· ${slipsPerPage} per page`;

  const extras = [includeResults && 'results sheets', includeAlpha && 'alpha lookup sheets'].filter(Boolean).join(' & ');
  setStatus('genStatus', 'ok', `âœ“ Generated ${totalSlips} slips across ${totalPages} pages${extras ? ' (incl. ' + extras + ')' : ''}. Ready to print.`);
  document.getElementById('btnPrint').disabled = false;

  const printArea = document.getElementById('printArea');
  printArea.style.display = 'block';
  printArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderResultsSheet(sec, roundLabel) {
  const secShort = sec.name.replace(/^.+?:\s*/, '');
  const tourneyName = sec.name.replace(/:\s*.+$/, '').trim();

  const page = document.createElement('div');
  page.className = 'results-page';

  // Header
  page.innerHTML = `
    <div class="results-header">
      <div class="results-title">${secShort} â€” Results</div>
      <div class="results-meta">${tourneyName}<br>${roundLabel}</div>
    </div>
  `;

  // Table
  const table = document.createElement('table');
  table.className = 'results-table';
  table.innerHTML = `
    <thead>
      <tr>
        <th class="rt-bd">Bd</th>
        <th class="rt-team">Team</th>
        <th class="rt-name">White Player</th>
        <th class="rt-result">Result</th>
        <th class="rt-name">Black Player</th>
        <th class="rt-team">Team</th>
      </tr>
    </thead>
  `;

  const tbody = document.createElement('tbody');

  sec.pairings.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="rt-bd">${p.bd}</td>
      <td class="rt-team">${p.white.team || ''}</td>
      <td class="rt-name">${p.white.name}${p.white.score ? ` <span style="color:#aaa;font-size:7.5pt">(${p.white.score})</span>` : ''}</td>
      <td class="rt-result">
        <div class="rt-result-inner">
          <span class="rt-circle"><span class="rt-circle-dot"></span>1-0</span>
          <span class="rt-circle"><span class="rt-circle-dot"></span>Â½-Â½</span>
          <span class="rt-circle"><span class="rt-circle-dot"></span>0-1</span>
        </div>
      </td>
      <td class="rt-name">${p.black.name ? p.black.name : '<span class="rt-bye">BYE</span>'}${p.black.score ? ` <span style="color:#aaa;font-size:7.5pt">(${p.black.score})</span>` : ''}</td>
      <td class="rt-team">${p.black.team || ''}</td>
    `;
    tbody.appendChild(tr);
  });

  // Byes
  if (sec.byes.length) {
    const byeHeader = document.createElement('tr');
    byeHeader.innerHTML = `<td colspan="6" style="padding:5px 6px 2px;font-size:7.5pt;font-weight:800;text-transform:uppercase;letter-spacing:0.5px;color:#888;border-top:1.5px solid #ccc;">Byes</td>`;
    tbody.appendChild(byeHeader);
    sec.byes.forEach(b => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="rt-bd">â€”</td>
        <td class="rt-team">${b.team || ''}</td>
        <td class="rt-name" colspan="3">${b.name}${b.score ? ` <span style="color:#aaa;font-size:7.5pt">(${b.score})</span>` : ''}</td>
        <td class="rt-team" style="color:#bbb;font-style:italic;font-size:7.5pt">BYE</td>
      `;
      tbody.appendChild(tr);
    });
  }

  table.appendChild(tbody);
  page.appendChild(table);

  page.innerHTML += `<div class="results-footer-note">RoundReady Â· The TD Toolkit Â· Richard Pointer Â· IO IA</div>`;

  return page;
}

function renderSlip(slip, slipH) {
  const p = slip.pairing;
  const secShort = slip.sec.replace(/^.+?:\s*/, '');

  const div = document.createElement('div');
  div.className = 'slip';
  // height handled by flex on .print-page

  const isBye = !p.black.name;

  const wMeta = [p.white.team, p.white.score ? `Score: ${p.white.score}` : ''].filter(Boolean).join(' Â· ');
  const bMeta = [p.black.team, p.black.score ? `Score: ${p.black.score}` : ''].filter(Boolean).join(' Â· ');

  div.innerHTML = `
    <!-- â”€â”€ WHITE (left) â”€â”€ -->
    <div class="slip-white">
      <div class="player-top">
        <div class="player-color-label"><span class="color-box color-box-white"></span> White</div>
        <div class="player-name">${p.white.name || 'â€”'}</div>
        ${wMeta ? `<div class="player-meta">${wMeta}</div>` : ''}
      </div>
      <div class="player-sig">
        <div class="sig-label">Signature</div>
        <div class="sig-line"></div>
      </div>
    </div>

    <!-- â”€â”€ CENTER â”€â”€ -->
    <div class="slip-center">
      <div class="center-top">
        <div class="board-label">Board</div>
        <div class="board-number">${p.bd}</div>
        <div class="center-section">${slip.round}<br>${secShort}</div>
      </div>

      <div class="result-area">
        <div class="result-label">Circle Result</div>
        <div class="result-options">
          <div class="result-option">
            <div class="result-circle"></div>
            <span class="result-text">1 â€“ 0</span>
            <span class="result-sub">White wins</span>
          </div>
          <div class="result-option">
            <div class="result-circle"></div>
            <span class="result-text">Â½ â€“ Â½</span>
            <span class="result-sub">Draw</span>
          </div>
          <div class="result-option">
            <div class="result-circle"></div>
            <span class="result-text">0 â€“ 1</span>
            <span class="result-sub">Black wins</span>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ BLACK (right) â”€â”€ -->
    <div class="slip-black">
      ${isBye
        ? '<div class="slip-bye-msg">â€” BYE â€”</div>'
        : `<div class="player-top">
            <div class="player-color-label"><span class="color-box color-box-black"></span> Black</div>
            <div class="player-name">${p.black.name}</div>
            ${bMeta ? `<div class="player-meta">${bMeta}</div>` : ''}
           </div>
           <div class="player-sig">
             <div class="sig-label">Signature</div>
             <div class="sig-line"></div>
           </div>`
      }
    </div>
  `;

  return div;
}

function renderAlphaSheet(sec, roundLabel) {
  const secShort    = sec.name.replace(/^.+?:\s*/, '');
  const tourneyName = sec.name.replace(/:\s*.+$/, '').trim();
  const timeControl = document.getElementById('timeControl').value.trim();

  // Build flat list of all players with their assignment
  const players = [];
  sec.pairings.forEach(p => {
    players.push({ name: p.white.name, team: p.white.team, bd: p.bd, color: 'White' });
    if (p.black.name) {
      players.push({ name: p.black.name, team: p.black.team, bd: p.bd, color: 'Black' });
    }
  });

  // Add byes
  sec.byes.forEach(b => {
    if (b.name) players.push({ name: b.name, team: b.team, bd: null, color: null });
  });

  // Sort alphabetically by last name (text before comma)
  players.sort((a, b) => {
    const lastName = n => (n.split(',')[0] || n).trim().toLowerCase();
    return lastName(a.name).localeCompare(lastName(b.name));
  });

  const page = document.createElement('div');
  page.className = 'alpha-page';

  page.innerHTML = `
    <div class="alpha-header">
      <div class="alpha-title">${secShort} â€” Player Lookup</div>
      <div class="alpha-meta">
        ${tourneyName}<br>
        ${roundLabel} Â· Alphabetical by Last Name
        ${timeControl ? `<br><strong>Time Control: ${timeControl}</strong>` : ''}
      </div>
    </div>
  `;

  const columns = document.createElement('div');
  columns.className = 'alpha-columns';

  // Single header row
  const hdr = document.createElement('div');
  hdr.className = 'alpha-col-header';
  hdr.innerHTML = `<span>Player (Team)</span><span>Assignment</span>`;
  columns.appendChild(hdr);

  players.forEach(player => {
    const row = document.createElement('div');
    row.className = 'alpha-row';

    const nameTeam = `<span class="alpha-name">${player.name}</span>${player.team ? ` <span class="alpha-team">${player.team}</span>` : ''}`;

    let assignment = '';
    if (player.bd === null) {
      assignment = `<span class="alpha-bye-tag">BYE</span>`;
    } else {
      const colorClass = player.color === 'White' ? 'alpha-color-w' : 'alpha-color-b';
      assignment = `<span class="alpha-assignment">Board <strong>${player.bd}</strong> Â· <span class="${colorClass}">${player.color}</span></span>`;
    }

    row.innerHTML = `<div>${nameTeam}</div>${assignment}`;
    columns.appendChild(row);
  });

  page.appendChild(columns);
  page.innerHTML += `<div class="results-footer-note">RoundReady Â· The TD Toolkit Â· Richard Pointer Â· IO IA</div>`;

  return page;
}

function setStatus(id, type, msg) {
  const el = document.getElementById(id);
  el.className = 'status ' + type;
  el.textContent = msg;
}
</script>
</body>
</html>
